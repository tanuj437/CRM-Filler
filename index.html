<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Data Filler Agent</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 1200px; }
        .card { margin-bottom: 1.5rem; }
        .card-header { font-weight: bold; }
        .results-container { display: none; }
        .spinner-border { width: 1.3rem; height: 1.3rem; }
        .action-log {
            max-height: 200px;
            overflow-y: auto;
            background: #f1f1f1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .table-responsive { max-height: 400px; overflow-y: auto; }
        td input { width: 100%; }
    </style>

</head>
<body>

<div class="container my-5">

    <h1 class="text-center mb-4">Automated Data Filler Agent</h1>

    <!-- INPUT SECTION -->
    <div class="card">
        <div class="card-body">

            <label class="form-label fw-bold">Paste Meeting Summary</label>
            <textarea id="summary-input" class="form-control" rows="8" placeholder="Paste meeting notes here..."></textarea>

            <button id="extract-btn" class="btn btn-primary mt-3">
                <span id="btn-text">Extract CRM Data</span>
                <span id="spinner" class="spinner-border ms-2" style="display:none;"></span>
            </button>

        </div>
    </div>

    <!-- RESULTS -->
    <div id="results" class="results-container">

        <h2 class="text-center mb-4">Extracted Information</h2>

        <!-- CONTACTS -->
        <div class="card">
            <div class="card-header bg-primary text-white">Contacts</div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="table-light">
                        <tr>
                            <th>Name</th>
                            <th>Job Title</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Decision Power</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody id="contact-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- COMPANIES -->
        <div class="card">
            <div class="card-header bg-success text-white">Company</div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="table-light">
                        <tr>
                            <th>Name</th>
                            <th>Industry</th>
                            <th>Size</th>
                            <th>Location</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody id="company-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- DEALS -->
        <div class="card">
            <div class="card-header bg-info text-white">Deals</div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="table-light">
                        <tr>
                            <th>Name</th>
                            <th>Value</th>
                            <th>Currency</th>
                            <th>Stage</th>
                            <th>Timeline</th>
                            <th>Next Steps</th>
                            <th>Competitors</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody id="deal-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- APPLY BUTTON -->
        <div class="text-center">
            <button id="apply-btn" class="btn btn-success btn-lg">Apply to CRM</button>
        </div>

        <!-- LOG -->
        <div class="card mt-4">
            <div class="card-header">Action Log</div>
            <div class="card-body">
                <div id="action-log" class="action-log"></div>
            </div>
        </div>

    </div>

</div>

<script>

    // DATA FROM BACKEND
    let crmData = { contact: [], company: [], deal: [] };

    const headers = {
        contact: ["name", "job_title", "email", "phone", "decision_power"],
        company: ["name", "industry", "size", "location"],
        deal: ["name", "value", "currency", "stage", "timeline", "next_steps", "competitors"]
    };

    // --------------------  EXTRACT BUTTON CLICK  --------------------
    document.getElementById("extract-btn").onclick = async () => {

        const summary = document.getElementById("summary-input").value.trim();

        if (!summary) return alert("Please paste meeting summary.");

        // Buttons state
        const btn = document.getElementById("extract-btn");
        const spinner = document.getElementById("spinner");
        const btnText = document.getElementById("btn-text");

        btn.disabled = true;
        spinner.style.display = "inline-block";
        btnText.textContent = "Extracting...";

        try {

            const response = await fetch("http://localhost:8000/extract", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    meeting_text: summary,
                    company_name: "Unknown",
                    contact_name: "Unknown"
                })
            });

            const data = await response.json();
            const extracted = data.extracted;

            crmData = {
                contact: extracted.contacts || [],
                company: extracted.companies || [],
                deal: extracted.deals || []
            };

            renderAllTables();
            document.getElementById("results").style.display = "block";
            logAction("CRM Data Extracted Successfully!");

        } catch (err) {
            console.error(err);
            alert("Backend error: Check console");
        }

        btn.disabled = false;
        spinner.style.display = "none";
        btnText.textContent = "Extract CRM Data";
    };


    // -------------------- RENDER TABLES --------------------
    function renderAllTables() {
        renderTable("contact");
        renderTable("company");
        renderTable("deal");
    }

    function renderTable(type) {

        const body = document.getElementById(`${type}-table-body`);
        body.innerHTML = "";

        crmData[type].forEach((item, index) => {
            const row = body.insertRow();
            row.setAttribute("data-index", index);

            headers[type].forEach(key => {
                const cell = row.insertCell();
                let v = item[key];
                if (Array.isArray(v)) v = v.join(", ");
                cell.textContent = v || "";
            });

            const actionCell = row.insertCell();
            actionCell.innerHTML = `
                <button class="btn btn-warning btn-sm" onclick="editRow('${type}', ${index}, this)">Edit</button>
            `;
        });
    }

    // -------------------- EDIT ROW --------------------
    function editRow(type, index, btn) {
        const row = btn.closest("tr");
        const cells = row.querySelectorAll("td");

        headers[type].forEach((key, i) => {
            const val = crmData[type][index][key] || "";
            cells[i].innerHTML = `<input class="form-control" value="${val}">`;
        });

        btn.textContent = "Save";
        btn.classList.remove("btn-warning");
        btn.classList.add("btn-success");
        btn.onclick = () => saveRow(type, index, btn);
    }

    // -------------------- SAVE ROW --------------------
    function saveRow(type, index, btn) {
        const row = btn.closest("tr");
        const inputs = row.querySelectorAll("input");

        inputs.forEach((inp, i) => {
            crmData[type][index][headers[type][i]] = inp.value;
        });

        renderTable(type);
        logAction(`${type} updated successfully`);
    }

    // -------------------- LOGGING --------------------
    function logAction(msg) {
        const log = document.getElementById("action-log");
        const time = new Date().toLocaleTimeString();
        log.innerHTML += `<div>[${time}] ${msg}</div>`;
        log.scrollTop = log.scrollHeight;
    }

</script>

</body>
</html>
